<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Snake Boss Survival ‚Äî v4.0.6</title>
<meta name="theme-color" content="#0b0f1d">
<style>
  :root{
    --bg1:#0b0f1d; --bg2:#0e1730; --accent:#8dfcc1; --muted:#b8c7e6;
    --glass:rgba(17,25,48,.55); --border:rgba(255,255,255,.12);
    --food:#ff5470; --snake:#47d16e; --head:#caffdd; --boss:#7aa2f7; --bossHead:#d7e7ff;
    --gold:#ffd166; --purple:#c084fc; --blue:#7dd3fc;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0; color:#e8f0ff; font-family:Inter, system-ui, Segoe UI, Roboto, Arial;
       background:linear-gradient(180deg, var(--bg1), var(--bg2));
       display:grid; grid-template-rows:auto 1fr auto; padding:10px 10px 8px}
  a{color:#a6ffe0; text-decoration:none} a:hover{text-decoration:underline}

  /* Header */
  .header{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px}
  .brand{display:flex; align-items:center; gap:10px}
  .logo{width:26px; height:26px}
  .titleTxt{font-weight:800; letter-spacing:.5px; font-size:clamp(16px,3.6vw,22px)}
  .actions{display:flex; align-items:center; gap:6px}
  .pill{padding:8px 12px; background:var(--glass); border:1px solid var(--border); border-radius:12px; -webkit-backdrop-filter: blur(8px); backdrop-filter: blur(8px); box-shadow:0 10px 30px rgba(0,0,0,.25); font-size:14px}
  .btn{cursor:pointer; user-select:none}
  .btn:active{transform:translateY(1px)}

  /* Stage */
  .frame{width:min(1200px,100%); margin:0 auto}
  .stage{position:relative}
  canvas{width:100%; height:auto; aspect-ratio:16/10; background:#0a0f1a; touch-action:none;
         border-radius:20px; border:1px solid var(--border);
         box-shadow:0 20px 60px rgba(0,0,0,.45); display:block; image-rendering: pixelated; outline:none}

  /* HUD */
  .hud{position:absolute; top:10px; left:50%; transform:translateX(-50%);
       display:grid; place-items:center; gap:6px; pointer-events:none}
  .scorepill{min-width:180px; padding:8px 14px; border-radius:14px;
             background:var(--glass); border:1px solid var(--border);
             -webkit-backdrop-filter: blur(8px); backdrop-filter: blur(8px);
             text-align:center; box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .score{font-weight:900; font-size:clamp(26px,6vw,52px); line-height:1; color:var(--head);
         text-shadow:0 6px 18px rgba(71,209,110,.45)}
  .best{font-size:12px; color:#b8c7e6}

  /* Help chip */
  #controlChip{ position:absolute; right:12px; top:12px; z-index:22;
    background:rgba(17,25,48,.6); border:1px solid rgba(255,255,255,.12);
    padding:6px 10px; border-radius:12px; font-size:12px; backdrop-filter:blur(8px) }

  /* Onboarding */
  #onboard{ position:absolute; inset:0; display:none; place-items:end center; padding-bottom:14vh; z-index:21; }
  .hintPulse{ position:absolute; left:50%; top:50%; width:110px; height:110px; border-radius:999px;
    border:2px solid rgba(255,255,255,.25); transform:translate(-50%,-50%); animation:pulse 1.6s ease-out infinite; }
  .hintDot{ position:absolute; left:50%; top:50%; width:56px; height:56px; border-radius:999px;
    transform:translate(-50%,-50%); background:rgba(30,200,160,.4); border:2px solid rgba(255,255,255,.35); }
  .hintArrow{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); font-size:22px; color:#cfe1ff; opacity:.9; animation:nudge 1.2s ease-in-out infinite; }
  @keyframes pulse { 0%{transform:translate(-50%,-50%) scale(0.85); opacity:.6} 70%{opacity:.15} 100%{transform:translate(-50%,-50%) scale(1.2); opacity:0} }
  @keyframes nudge { 0%{transform:translate(-50%,-50%) translateX(-12px)} 50%{transform:translate(-50%,-50%) translateX(12px)} 100%{transform:translate(-50%,-50%) translateX(-12px)} }

  /* Ghost arrows */
  #ghostArrows{ position:absolute; inset:0; pointer-events:none; z-index:20; display:none; }
  .ga{ font-size:22px; color:#cfe1ff; text-shadow:0 0 10px rgba(255,255,255,.15); transition:opacity .6s; position:absolute; }
  .ga.left{ left:8px; top:50%; transform:translateY(-50%); }
  .ga.right{ right:8px; top:50%; transform:translateY(-50%); }
  .ga.up{ left:50%; top:8px; transform:translateX(-50%); }
  .ga.down{ left:50%; bottom:8px; transform:translateX(-50%); }

  /* Hero overlay */
  .hero{position:absolute; inset:0; display:grid; place-items:center; gap:16px;
        background:linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.25));
        border-radius:20px}
  .title{font-weight:900; font-size:clamp(22px,6vw,38px); color:#8dfcc1;
         text-shadow:0 0 22px rgba(141,252,193,.45)}
  .cta{pointer-events:auto; padding:12px 18px; border-radius:14px;
       background:linear-gradient(180deg,#10305a,#0b1b36); color:#e6f7ff;
       border:1px solid var(--border); box-shadow:0 10px 22px rgba(0,0,0,.35);
       font-weight:600}
  .hint{font-size:12px; color:#cfe1ff; opacity:.9}
  .hide{display:none}

  /* Settings */
  .settings{ position:fixed; right:12px; top:56px; width:260px; display:none;
             background:var(--glass); border:1px solid var(--border); border-radius:14px;
             padding:12px; -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px);
             box-shadow:0 12px 40px rgba(0,0,0,.45); z-index:30 }
  .settings h3{ margin:0 0 8px 0; font-size:14px; color:#dbeafe }
  .row{ display:flex; justify-content:space-between; align-items:center; margin:8px 0 }
  .switch{ display:inline-flex; align-items:center; gap:8px; cursor:pointer }
  .switch input{ appearance:none; width:36px; height:20px; border-radius:999px; background:#243655; position:relative; outline:none; border:1px solid var(--border) }
  .switch input:checked{ background:#3aa675 }
  .switch input::after{ content:""; position:absolute; left:2px; top:2px; width:16px; height:16px; border-radius:50%; background:#e6f0ff; transition:left .2s }
  .switch input:checked::after{ left:18px }
  .range{ width:120px }

  footer{ width:min(1200px,100%); margin:10px auto 0; color:#cfe1ff; opacity:.9;
          display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap; font-size:14px }
  .social a{ margin-right:10px }
</style>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
</head>
<body>
<header class="header frame">
  <div class="brand">
    <svg class="logo" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <rect x="6" y="6" width="52" height="52" rx="12" fill="#0f1c36" stroke="#304b7a"/>
      <rect x="16" y="16" width="12" height="12" rx="3" fill="#8dfcc1"/>
      <rect x="30" y="16" width="12" height="12" rx="3" fill="#caffdd"/>
      <rect x="44" y="16" width="12" height="12" rx="3" fill="#8db8ff"/>
      <rect x="16" y="30" width="12" height="12" rx="3" fill="#47d16e"/>
      <rect x="30" y="30" width="12" height="12" rx="3" fill="#47d16e"/>
      <rect x="30" y="44" width="12" height="12" rx="3" fill="#47d16e"/>
    </svg>
    <div class="titleTxt">Snake Boss Survival</div>
  </div>
  <div class="actions">
    <div id="pauseBtn" class="pill btn" title="Pausa/√Öteruppta">‚è∏Ô∏é Paus</div>
    <div id="settingsBtn" class="pill btn" title="Inst√§llningar">‚öôÔ∏é Inst√§llningar</div>
  </div>
</header>

<div class="frame">
  <div class="stage">
    <canvas id="cv" width="960" height="600" aria-label="Snake Boss Survival ‚Äî v4.0.6"></canvas>

    <!-- HUD -->
    <div class="hud">
      <div class="scorepill">
        <div id="score" class="score">0</div>
        <div class="best">üëë Rekord: <span id="best">0</span></div>
      </div>
    </div>

    <!-- Help chip -->
    <div id="controlChip">üëâ Dra p√• spelplanen f√∂r att styra</div>

    <!-- Onboarding -->
    <div id="onboard">
      <div style="position:relative; width:160px; height:160px;">
        <div class="hintPulse"></div>
        <div class="hintDot"></div>
        <div class="hintArrow">‚ÜîÔ∏é</div>
        <div style="position:absolute; left:50%; top:calc(50% + 70px); transform:translateX(-50%); font-size:12px; color:#dbeafe; opacity:.9;">H√•ll & dra</div>
      </div>
    </div>

    <!-- Ghost arrows -->
    <div id="ghostArrows">
      <div class="ga left">‚óÄ</div>
      <div class="ga right">‚ñ∂</div>
      <div class="ga up">‚ñ≤</div>
      <div class="ga down">‚ñº</div>
    </div>

    <div id="recordPop" class="recordPop" style="display:none; position:absolute; left:50%; top:20%; transform:translate(-50%,-50%);
      font-family: 'VT323', ui-monospace, Menlo, monospace; font-size:clamp(28px,8vw,64px); color:#fff;
      text-shadow:2px 2px 0 #000, -2px -2px 0 #000;">‚òÖ NEW RECORD! ‚òÖ</div>

    <!-- Hero overlay -->
    <div id="hero" class="hero">
      <div>
        <div class="title" style="text-align:center;margin-bottom:8px">SNAKE BOSS SURVIVAL</div>
        <div style="text-align:center; color:#cfe1ff; margin-bottom:12px">√Ñt f√∂re bossen. Undvik krockar. Sl√• rekordet.</div>
        <div style="display:grid; place-items:center; gap:10px">
          <button id="start" class="cta">‚ñ∂ Starta</button>
          <div class="hint">Mobil: h√•ll & dra p√• spelplanen ‚Ä¢ Desktop: piltangenter</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="settings" class="settings">
  <h3>Inst√§llningar</h3>
  <div class="row">
    <label class="switch">SFX
      <input id="sfxToggle" type="checkbox" checked>
    </label>
    <input id="sfxVol" class="range" type="range" min="0" max="100" value="40">
  </div>
  <div class="row">
    <label class="switch">Musik
      <input id="musicToggle" type="checkbox" checked>
    </label>
    <input id="musicVol" class="range" type="range" min="0" max="100" value="35">
  </div>
</div>

<audio id="bgm" src="soundtrack.mp3" preload="auto" loop></audio>

<footer>
  <div>Made by <strong>Niclas Vestlund</strong> ‚Äî med ‚ù§Ô∏è</div>
  <div class="social">
    <a href="https://www.youtube.com/@niclasvestlundYT" target="_blank" rel="noopener">YouTube</a>
    <a href="https://www.tiktok.com/@niclasvestlund" target="_blank" rel="noopener">TikTok</a>
    <a href="https://www.instagram.com/niclasvestlund" target="_blank" rel="noopener">Instagram</a>
    <a href="https://twitter.com/niclasvestlund" target="_blank" rel="noopener">X</a>
    <a href="https://niclasvestlund.se" target="_blank" rel="noopener">Webb</a>
  </div>
</footer>

<script>
(()=>{
const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent) || (Math.min(innerWidth, innerHeight) < 820);
if(isMobile) document.body.classList.add('mobile');

const cv = document.getElementById('cv'), ctx=cv.getContext('2d');
// Internal logical grid
let cols=30, rows=20; 
let cell = 20, padX=0, padY=0;

const ui = {
  score: byId('score'), best: byId('best'),
  hero: byId('hero'), start: byId('start'),
  bgm: byId('bgm'),
  pauseBtn: byId('pauseBtn'), settingsBtn: byId('settingsBtn'), settings: byId('settings'),
  sfxToggle: byId('sfxToggle'), musicToggle: byId('musicToggle'),
  sfxVol: byId('sfxVol'), musicVol: byId('musicVol'),
  recordPop: byId('recordPop'),
  chip: byId('controlChip'), onboard: byId('onboard'), ghosts: byId('ghostArrows')
};
function byId(id){ return document.getElementById(id); }

/* DPR-aware resize: keep 16:10 CSS aspect, scale internal buffer to DPR for sharpness */
function resizeCanvas(){
  const stage = cv.parentElement.getBoundingClientRect();
  const cssW = Math.max(320, stage.width - 24);
  const cssH = cssW * (10/16);
  const dpr = Math.min(2, window.devicePixelRatio || 1); // cap dpr for perf
  cv.style.width = cssW + 'px';
  cv.style.height = cssH + 'px';
  cv.width  = Math.floor(cssW * dpr);
  cv.height = Math.floor(cssH * dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);

  // recompute grid cell
  cell = Math.floor(Math.min(cv.width/dpr/cols, cv.height/dpr/rows));
  padX = Math.floor((cv.width/dpr - cols*cell)/2);
  padY = Math.floor((cv.height/dpr - rows*cell)/2);
}
resizeCanvas();
addEventListener('resize', resizeCanvas);
addEventListener('orientationchange', ()=> setTimeout(resizeCanvas, 200));

/* SFX */
let sfxEnabled = true; let musicEnabled = true;
let AC=null, master=null, sfxGain=null;
function initAC(){ if(AC) return; AC = new (window.AudioContext || window.webkitAudioContext)();
  master = AC.createGain(); master.gain.value = 1; master.connect(AC.destination);
  sfxGain = AC.createGain(); sfxGain.gain.value = ui.sfxVol.value/100; sfxGain.connect(master);
}
function primeAudio(){ initAC(); AC.resume().catch(()=>{}); }
function sfxEat(){ if(!sfxEnabled || !AC) return; beep(420,600,0.12,'triangle',0.35); }
function sfxDeath(){ if(!sfxEnabled || !AC) return; beep(300,120,0.35,'square',0.5); }
function sfxRecord(){ if(!sfxEnabled || !AC) return; beep(660,990,0.28,'sine',0.45); }
function beep(from,to,dur,type,gpeak){
  const o=AC.createOscillator(), g=AC.createGain(); o.type=type; o.frequency.setValueAtTime(from, AC.currentTime);
  o.frequency.exponentialRampToValueAtTime(to, AC.currentTime+Math.min(0.1,dur*0.7));
  g.gain.setValueAtTime(0.0001, AC.currentTime);
  g.gain.exponentialRampToValueAtTime(gpeak, AC.currentTime+0.02);
  g.gain.exponentialRampToValueAtTime(0.0001, AC.currentTime+dur);
  o.connect(g); g.connect(sfxGain); o.start(); o.stop(AC.currentTime+dur+0.02);
}

/* Settings */
ui.settingsBtn.onclick = ()=>{ ui.settings.style.display = (ui.settings.style.display==='block'?'none':'block'); };
document.addEventListener('click', (e)=>{ if(e.target.closest('#settings')||e.target.closest('#settingsBtn')) return; ui.settings.style.display='none'; });
ui.sfxToggle.onchange = ()=>{ sfxEnabled = ui.sfxToggle.checked; if(sfxEnabled){ initAC(); AC.resume(); sfxRecord(); } };
ui.musicToggle.onchange = ()=>{ musicEnabled = ui.musicToggle.checked; if(!musicEnabled) ui.bgm.pause(); else { try{ ui.bgm.volume=ui.musicVol.value/100; ui.bgm.play(); }catch(e){} } };
ui.sfxVol.oninput = ()=>{ initAC(); sfxGain.gain.value = ui.sfxVol.value/100; };
ui.musicVol.oninput = ()=>{ ui.bgm.volume = ui.musicVol.value/100; };

/* Game state */
let running=false, paused=false, loopId=null, tickMs=120;
let snake, dir='right', nextDir='right', food, score=0, best=parseInt(localStorage.getItem('sbs_best_v406')||'0');
let boss, bossAlt=false;
let shieldTicks=0;
let lastGlow='default';
let bossEasyTicks=40; // ~5s lugnare boss i b√∂rjan

/* Parallax */
let layers=[];
function spawnStars(n, color){ const arr=[]; for(let i=0;i<n;i++){ arr.push({x:Math.random()*(cv.width), y:Math.random()*(cv.height), c:color}); } return arr; }
function drawParallax(){
  layers.forEach(L=>{
    L.stars.forEach(s=>{
      s.x -= L.speed;
      if(s.x < -2) s.x = cv.width+2;
      ctx.fillStyle=s.c;
      ctx.fillRect(Math.floor(s.x), Math.floor(s.y), 2, 2);
    });
  });
}

reset(); draw();

function reset(){
  layers = [
    {speed:0.3, stars:spawnStars(50, '#1a2b53')},
    {speed:0.6, stars:spawnStars(35, '#253d77')},
    {speed:1.0, stars:spawnStars(20, '#3c5aa8')}
  ];
  const sy = Math.floor(rows/2);
  snake=[{x:Math.floor(cols/2)-5,y:sy},{x:Math.floor(cols/2)-6,y:sy},{x:Math.floor(cols/2)-7,y:sy}];
  dir='right'; nextDir='right';
  const by = Math.max(2, sy-6);
  boss=[{x:cols-5, y:by},{x:cols-6, y:by},{x:cols-7, y:by}];
  bossAlt=false;
  food = safeFood();
  score=0; ui.score.textContent=score; ui.best.textContent=best;
  shieldTicks = 10;
  lastGlow='default';
  bossEasyTicks=40;
  // onboarding
  const learned = localStorage.getItem('sbs_learned_controls')==='1';
  ui.onboard.style.display = learned ? 'none' : 'grid';
  hintGhosts();
}

function hintGhosts(){
  ui.ghosts.style.display='block';
  setTimeout(()=> ui.ghosts.style.display='none', 2000);
}

/* Helpers */
function safeFood(){
  let c;
  do{
    c = {x:(Math.random()*cols)|0, y:(Math.random()*rows)|0};
  } while(dist(c, snake[0])<8 || dist(c, boss[0])<8 || onSnakeOrBoss(c));
  return c;
}
function onSnakeOrBoss(p){ return snake.some(s=>s.x===p.x&&s.y===p.y) || boss.some(b=>b.x===p.x&&b.y===p.y); }
function dist(a,b){ return Math.abs(a.x-b.x)+Math.abs(a.y-b.y); }
function wrap(v,max){ return (v+max)%max; }

/* Input */
function start(){
  if(running) return;
  running=true; paused=false; ui.hero.classList.add('hide');
  initAC(); try{ if(musicEnabled){ ui.bgm.volume = ui.musicVol.value/100; ui.bgm.play(); } }catch(e){};
  if(loopId) clearInterval(loopId);
  loopId = setInterval(()=>{ if(!paused) { tick(); draw(); } }, tickMs);
}
ui.start.onclick = start;
cv.addEventListener('click', ()=>start());
window.addEventListener('keydown', e=>{
  const k=e.key.toLowerCase();
  if(k==='arrowup'||k==='w') setDir('up');
  else if(k==='arrowdown'||k==='s') setDir('down');
  else if(k==='arrowleft'||k==='a') setDir('left');
  else if(k==='arrowright'||k==='d') setDir('right');
  else if(k===' '||k==='enter') start();
  else if(k==='p') togglePause();
});

ui.pauseBtn.onclick = togglePause;
function togglePause(){
  if(!running){ start(); return; }
  paused = !paused;
  ui.pauseBtn.textContent = paused ? '‚ñ∂ Forts√§tt' : '‚è∏Ô∏é Paus';
}

function setDir(d){
  const map={up:[0,-1],down:[0,1],left:[-1,0],right:[1,0]};
  const [dx,dy]=map[d], [cx,cy]=map[dir];
  if(dx===-cx && dy===-cy) return;
  nextDir=d;
  learned();
}

/* Onboard state */
function learned(){
  if(localStorage.getItem('sbs_learned_controls')==='1') return;
  localStorage.setItem('sbs_learned_controls','1');
  ui.onboard.style.display='none';
  ui.chip.style.opacity=.35;
}

/* Canvas drag-to-steer (portrait + landscape) */
let swStartX=0, swStartY=0, swActive=false;
const SW_DEAD = isMobile ? 22 : 14, SW_SNAP_MS=90; let swLast=0;
cv.addEventListener('touchstart', (e)=>{ 
  const t=e.touches[0]; swStartX=t.clientX; swStartY=t.clientY; swActive=true; e.preventDefault(); start(); 
}, {passive:false});
cv.addEventListener('touchmove', (e)=>{
  if(!swActive) return;
  const t=e.touches[0]; const dx=t.clientX-swStartX, dy=t.clientY-swStartY;
  if(Math.hypot(dx,dy) < SW_DEAD) return;
  const now=performance.now(); if(now - swLast < SW_SNAP_MS) return;
  if(Math.abs(dx)>Math.abs(dy)) setDir(dx>0?'right':'left'); else setDir(dy>0?'down':'up');
  swLast=now; e.preventDefault();
}, {passive:false});
cv.addEventListener('touchend', ()=>{ swActive=false; }, {passive:true});

/* Tick */
function tick(){
  const map={up:[0,-1],down:[0,1],left:[-1,0],right:[1,0]};
  const [dx,dy]=map[nextDir];
  const head={x:wrap(snake[0].x+dx,cols), y:wrap(snake[0].y+dy,rows)};

  // collisions
  if(shieldTicks<=0){
    if(snake.some((s,i)=>i>0 && s.x===head.x && s.y===head.y)) return gameOver('Du √•t upp dig sj√§lv');
    if(boss.some(b=>b.x===head.x && b.y===head.y)) return gameOver('Du krockade med bossen');
  } else { shieldTicks--; }

  snake.unshift(head); dir=nextDir;

  // eat
  if(head.x===food.x && head.y===food.y){
    score++; ui.score.textContent=score; if(AC) sfxEat();
    if(score>best){ best=score; localStorage.setItem('sbs_best_v406', best); ui.best.textContent=best; showRecordPop(); if(AC) sfxRecord(); }
    if(score>=15) lastGlow='gold'; else if(score>=10) lastGlow='purple'; else if(score>=5) lastGlow='blue';
    food = safeFood();
  } else {
    snake.pop();
  }

  // boss AI (lugnare i b√∂rjan)
  let stepMult = (bossEasyTicks>0) ? 0.5 : 1; bossEasyTicks=Math.max(0,bossEasyTicks-1);
  const steps=(shieldTicks>0)?0:((bossAlt?2:1)*stepMult|0 || 1*stepMult|0);
  bossAlt=!bossAlt;
  for(let i=0;i<steps;i++){
    bossStep(); if(boss[0].x===food.x && boss[0].y===food.y){ food=safeFood(); break; }
  }
}
function bossStep(){
  const h=boss[0]; const opts=[{x:-1,y:0},{x:1,y:0},{x:0,y:-1},{x:0,y:1}];
  opts.sort((a,b)=> (Math.abs((h.x+a.x)-food.x)+Math.abs((h.y+a.y)-food.y)) - (Math.abs((h.x+b.x)-food.x)+Math.abs((h.y+b.y)-food.y)));
  const n={x:wrap(h.x+opts[0].x,cols), y:wrap(h.y+opts[0].y,rows)}; boss.unshift(n); boss.pop();
}

/* Draw */
function draw(){
  ctx.setTransform(ctx.getTransform()); // keep DPR scaling
  ctx.clearRect(0,0,cv.width,cv.height);
  drawParallax();
  ctx.save();
  ctx.translate(padX, padY);
  // grid
  for(let y=0;y<rows;y++){
    for(let x=0;x<cols;x++){
      ctx.globalAlpha=((x+y)%2===0)?0.06:0.04; ctx.fillStyle='#7aa2f7';
      ctx.fillRect(x*cell,y*cell,cell,cell);
    }
  }
  ctx.globalAlpha=1;
  // food
  const t=Date.now()*0.004, bob=Math.sin(t*2)*2, fx=food.x*cell+4, fy=food.y*cell+4+bob, pulse=(Math.sin(t*3)*0.5+0.5)*0.3+0.7;
  ctx.fillStyle=getCSS('--food'); ctx.globalAlpha=pulse; ctx.fillRect(fx,fy,cell-8,cell-8); ctx.globalAlpha=1;
  // snake
  let glow='#2cff96'; if(lastGlow==='blue') glow='rgba(125,211,252,0.8)'; if(lastGlow==='purple') glow='rgba(192,132,252,0.85)'; if(lastGlow==='gold') glow='rgba(255,209,102,0.9)';
  for(let i=snake.length-1;i>=0;i--){ const s=snake[i], isHead=i===0; if(isHead){ ctx.fillStyle=glow; ctx.globalAlpha=0.25; ctx.fillRect(s.x*cell,s.y*cell,cell,cell); ctx.globalAlpha=1; ctx.fillStyle=getCSS('--head'); } else { ctx.fillStyle=getCSS('--snake'); } roundRect(s.x*cell+1,s.y*cell+1,cell-2,cell-2,6); ctx.fill(); }
  // boss
  const near = dist(snake[0], boss[0]) <= 4;
  for(let i=boss.length-1;i>=0;i--){ const b=boss[i], isHead=i===0; if(isHead && near){ ctx.fillStyle='rgba(255,80,80,0.25)'; ctx.fillRect(b.x*cell,b.y*cell,cell,cell); } ctx.fillStyle=(isHead?getCSS('--bossHead'):getCSS('--boss')); roundRect(b.x*cell+2,b.y*cell+2,cell-4,cell-4,6); ctx.fill(); }
  ctx.restore();
}
function roundRect(x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }
function getCSS(v){ return getComputedStyle(document.documentElement).getPropertyValue(v).trim(); }

/* Record popup */
function showRecordPop(){ ui.recordPop.style.display='block'; setTimeout(()=> ui.recordPop.style.display='none', 1200); }

/* Game over */
function gameOver(reason){
  running=false; paused=false; ui.pauseBtn.textContent='‚è∏Ô∏é Paus';
  if(AC) sfxDeath();
  setTimeout(()=>{ ui.hero.classList.remove('hide'); ui.start.textContent='‚ñ∂ Spela igen';
    ui.hero.querySelector('.hint').textContent=(reason||'Game over')+' ‚Ä¢ Tryck start';
    reset(); draw();
  }, 400);
}
})();</script>
</body>
</html>
